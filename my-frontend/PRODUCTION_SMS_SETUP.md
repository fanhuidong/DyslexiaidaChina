# 生产环境短信验证码配置指南

## 问题说明

在生产环境中，如果没有配置短信宝账号，系统会返回"短信服务未配置"的错误，导致无法发送验证码。

## 解决方案

### 方案 1：配置短信宝账号（推荐）

#### 步骤 1：获取短信宝账号

1. 访问 [短信宝官网](http://www.smsbao.com/)
2. 注册账号并登录
3. 在控制台获取用户名和密码
4. 充值（确保账户有足够余额）

#### 步骤 2：获取 MD5 加密后的密码

短信宝要求使用 MD5 加密后的密码。可以使用以下方式：

**Node.js 方式：**
```javascript
const crypto = require('crypto');
const password = '你的原始密码';
const md5Password = crypto.createHash('md5').update(password).digest('hex');
console.log(md5Password);
```

**在线工具：**
访问 MD5 在线加密工具，输入密码后获取 MD5 值。

#### 步骤 3：配置环境变量

在部署平台（如 Vercel）的环境变量中添加：

```env
SMS_BAO_USERNAME=你的短信宝用户名
SMS_BAO_PASSWORD=MD5加密后的密码
SMS_BAO_API_URL=http://api.smsbao.com/sms
```

**Vercel 配置步骤：**
1. 登录 Vercel 控制台
2. 选择你的项目
3. 进入 Settings → Environment Variables
4. 添加以下变量：
   - `SMS_BAO_USERNAME` = 你的用户名
   - `SMS_BAO_PASSWORD` = MD5加密后的密码
   - `SMS_BAO_API_URL` = http://api.smsbao.com/sms（可选，默认值）
5. 保存并重新部署

### 方案 2：临时调试模式（不推荐用于生产）

如果暂时无法配置短信宝，可以修改代码让生产环境也在日志中输出验证码（仅用于调试）。

**注意：** 这种方式不安全，仅用于临时调试，生产环境应该配置真实的短信服务。

## 验证配置

配置完成后，测试步骤：

1. 重新部署应用
2. 访问注册页面
3. 输入手机号并点击"发送验证码"
4. 检查手机是否收到验证码短信

## 常见问题

### Q: 配置后仍然收不到验证码？

**检查清单：**
1. ✅ 环境变量是否正确配置（检查大小写）
2. ✅ 密码是否使用 MD5 加密
3. ✅ 短信宝账户是否有余额
4. ✅ 手机号格式是否正确（11位，以1开头）
5. ✅ 查看服务器日志是否有错误信息

### Q: 如何查看服务器日志？

**Vercel：**
1. 进入项目控制台
2. 点击 "Deployments" 标签
3. 选择最新的部署
4. 点击 "Functions" 标签
5. 查看函数日志

**其他平台：**
根据平台文档查看日志输出。

### Q: 短信发送失败的错误码含义？

- `-1` - 账号不存在
- `-2` - 接口密钥不正确
- `-21` - MD5接口密钥加密不正确
- `-3` - 短信数量不足（需要充值）
- `-11` - 该用户被禁用
- `-14` - 短信内容出现非法字符
- `-41` - 手机号码为空
- `-42` - 手机号码格式不正确
- `-51` - 短信签名格式不正确
- `-6` - IP限制

### Q: 如何测试配置是否生效？

可以在代码中添加日志来验证：

```typescript
console.log('SMS配置检查:', {
  hasUsername: !!process.env.SMS_BAO_USERNAME,
  hasPassword: !!process.env.SMS_BAO_PASSWORD,
  username: process.env.SMS_BAO_USERNAME ? '已配置' : '未配置'
});
```

## 安全建议

1. **不要**在代码中硬编码短信宝账号密码
2. **使用**环境变量存储敏感信息
3. **定期**检查短信宝账户余额
4. **监控**短信发送失败率
5. **设置**短信发送频率限制（已实现：1分钟限制）

## 成本估算

短信宝的收费标准：
- 通常每条短信 0.05-0.1 元
- 建议根据预期用户量充值
- 可以设置余额告警

## 备用方案

如果短信宝服务不稳定，可以考虑：
1. 阿里云短信服务
2. 腾讯云短信服务
3. 其他短信服务提供商

需要修改 `src/lib/sms.ts` 文件来适配不同的服务商。
